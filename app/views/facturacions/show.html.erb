<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 my-8">

  <div class="flex items-center justify-start mb-6">
    <%= link_to "Volver a cotizaciones",
                home_path(tab: "cotizaciones"),
                class: "inline-flex items-center px-4 py-2 border border-transparent \
                        text-base leading-6 font-medium rounded-md text-blue-400 \
                        bg-gray-800 hover:bg-blue-800 hover:text-white focus:outline-none \
                        focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out"
    %>
  </div>

  <div class="bg-gray-900 p-4 rounded-lg shadow-md">
    <div class="grid grid-cols-2 gap-2 text-white">

      <div>
        <h2 class="text-2xl font-bold mb-1">
          Cotización N° <%= @facturacion.number %> <%= @facturacion.name %>
        </h2>
      </div>

      <% if Current.user.solicitar %>

        <div class="flex items-center space-x-2">
          <%= link_to "Editar Solicitud",
                      edit_facturacion_path(@facturacion),
                      class: "px-3 py-2 rounded bg-green-500 text-gray-900 font-bold \
                              hover:bg-green-600 transition duration-200" %>
        </div>


      <% end %>



      <div class="mt-6">
        <p class="mb-0"><strong>Solicitud:</strong> <%= format_date(@facturacion.solicitud) %></p>
        <p class="mb-0"><strong>Emisión:</strong> <%= format_date(@facturacion.emicion) %></p>
        <p class="mb-0"><strong>Entregado:</strong> <%= format_date(@facturacion.entregado) %></p>
        <p class="mb-0"><strong>Resultado:</strong> <%= @facturacion.resultado %></p>
        <p class="mb-0"><strong>Orden de compra (OC):</strong> <%= format_date(@facturacion.oc) %></p>
        <p class="mb-0"><strong>Factura:</strong> <%= format_date(@facturacion.factura) %></p>
        <p class="mb-0"><strong>Fecha de evaluación:</strong> <%= format_date(@facturacion.fecha_inspeccion) %></p>

        <% if @facturacion.emicion.present? %>
          <div id="precio-container" class="mb-0">
            <strong>Precio (sin iva):</strong>
            <span id="precio-text"><%= @facturacion.precio %></span> UF

            <button
              id="editar-precio-btn"
              class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-600 text-white ml-2"
              onclick="startEditPrecio()">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                   stroke-width="2" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M15.232 5.232l3.536 3.536M2.999 17.999l4.242-.354.354-4.242 9.536-9.536a1.5 1.5 0 012.121 0l.707.707a1.5 1.5 0 010 2.121l-9.536 9.536z" />
              </svg>
            </button>
          </div>
        <% else %>
          <p class="mb-0">
            <strong>Precio (sin iva):</strong>
            <%= @facturacion.precio %> UF
          </p>
        <% end %>
      </div>





      <div class="mt-6">
      </div>
    </div>

    <hr class="my-4 border-gray-700" />

    <h3 class="text-xl font-semibold mb-2 text-white">Archivos disponibles</h3>
    <div class="mb-4">
      <%= link_to "Modificar archivos",
                  manage_files_facturacion_path(@facturacion),
                  class: "inline-block px-4 py-2 rounded bg-yellow-500 text-gray-900 font-bold hover:bg-yellow-600 transition duration-200" %>
    </div>


    <div class="space-y-2">
      <% if @facturacion.solicitud_file.attached? %>
        <%= link_to "Descargar solicitud .xlsx",
                    download_solicitud_file_facturacion_path(@facturacion),
                    class: "inline-block px-3 py-2 rounded bg-indigo-500 text-gray-900 font-bold hover:bg-indigo-600 transition" %>
      <% else %>
        <p>No hay archivo de solicitud.</p>
      <% end %>

      <% if @facturacion.cotizacion_doc_file.attached? %>
        <%= link_to "Descargar cotización .doc",
                    download_cotizacion_doc_file_facturacion_path(@facturacion),
                    class: "inline-block px-3 py-2 rounded bg-indigo-500 text-gray-900 font-bold hover:bg-indigo-600 transition" %>
      <% end %>

      <% if @facturacion.cotizacion_pdf_file.attached? %>
        <%= link_to "Descargar cotización .pdf",
                    download_cotizacion_pdf_file_facturacion_path(@facturacion),
                    class: "inline-block px-3 py-2 rounded bg-indigo-500 text-gray-900 font-bold hover:bg-indigo-600 transition" %>
      <% end %>

      <% if @facturacion.orden_compra_file.attached? %>
        <%= link_to "Descargar orden de compra",
                    download_orden_compra_file_facturacion_path(@facturacion),
                    class: "inline-block px-3 py-2 rounded bg-indigo-500 text-gray-900 font-bold hover:bg-indigo-600 transition" %>
      <% end %>

      <% if @facturacion.facturacion_file.attached? %>
        <%= link_to "Descargar facturación",
                    download_facturacion_file_facturacion_path(@facturacion),
                    class: "inline-block px-3 py-2 rounded bg-indigo-500 text-gray-900 font-bold hover:bg-indigo-600 transition" %>
      <% end %>
    </div>

    <div class="mt-4">
      <%= link_to "Descargar todos los archivos (.zip)",
                  download_all_files_facturacion_path(@facturacion),
                  class: "inline-block px-4 py-2 rounded bg-green-500 text-gray-900 font-bold hover:bg-green-600 transition" %>
    </div>


  </div>
</div>

<div class="bg-gray-900 p-4 rounded-lg shadow-md mt-8 text-white">
  <h3 class="text-xl font-semibold mb-4">Progreso de la Cotización</h3>

  <div
    class="relative flex items-center justify-between w-full h-24 bg-gray-800 rounded-lg px-4 py-6"
    id="timeline-steps"
    data-controller="timeline"
    data-timeline-facturacion-id-value="<%= @facturacion.id %>"
  >
    <% steps = Facturacion::STEPS %>
    <% paso_actual = @facturacion.paso_actual || 0 %>
    <div class="absolute top-1/2 left-0 h-1 w-full bg-gray-600 rounded z-0">
      <div class="bg-blue-500 h-1 rounded"
           style="width: calc(100% / <%= steps.size - 1 %> * <%= paso_actual %>);"></div>
    </div>
    <% steps.each_with_index do |name, idx| %>
      <% state_class =
           if idx < paso_actual
             "border-blue-500 bg-blue-500"
           elsif idx == paso_actual
             "border-green-500 bg-green-500 ring-4 ring-green-300"
           else
             "border-gray-500 bg-gray-600"
           end
      %>
      <div class="relative z-10 flex flex-col items-center w-1/5 group cursor-pointer">
        <div
          class="flex items-center justify-center w-8 h-8 rounded-full border-2 <%= state_class %>"
          data-action="click->timeline#setPasoActual"
          data-idx="<%= idx %>"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
               stroke-width="2" stroke="currentColor" class="w-4 h-4 text-white">
            <% if idx < paso_actual %>
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            <% elsif idx == paso_actual %>
              <circle cx="12" cy="12" r="10" />
            <% else %>
              <circle cx="12" cy="12" r="10" />
            <% end %>
          </svg>
        </div>
        <p class="mt-4 text-m <%= idx <= paso_actual ? 'text-white font-bold' : 'text-gray-400' %>"><%= name %></p>
      </div>
    <% end %>
  </div>
</div>


<% if Current.user.cotizar && @facturacion.paso_actual == 1  %>
  <div class="bg-gray-900 p-4 rounded-lg shadow-md mt-8">
    <h3 class="text-xl font-semibold text-white mb-4">Subir documentos de cotización</h3>

    <%= form_with(model: @facturacion, url: upload_cotizacion_facturacion_path(@facturacion), local: true, class: "space-y-4") do |form| %>
      <div>
        <%= form.label :cotizacion_doc_file, "Archivo de Cotización (DOCX)", class: "block text-gray-300 font-bold mb-2" %>
        <%= form.file_field :cotizacion_doc_file, accept: ".doc,.docx", class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" %>
      </div>

      <div>
        <%= form.label :cotizacion_pdf_file, "Archivo de Cotización (PDF)", class: "block text-gray-300 font-bold mb-2" %>
        <%= form.file_field :cotizacion_pdf_file, accept: "application/pdf", class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" %>
      </div>
      <div class="mt-4">
        <%= form.submit "Subir Documentos", class: "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline cursor-pointer" %>
      </div>
    <% end %>
  </div>
<% end %>


<% if Current.user.solicitar && @facturacion.paso_actual == 2  %>
  <div class="bg-gray-900 p-4 rounded-lg shadow-md mt-8">
    <h3 class="text-xl font-semibold text-white mb-4">Acciones de Entrega</h3>
    <button
      data-controller="confirm-entrega"
      data-action="click->confirm-entrega#confirmEntrega"
      data-confirm-entrega-url-value="<%= marcar_entregado_facturacion_path(@facturacion) %>"
      class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline cursor-pointer">
      Marcar como entregado
    </button>
  </div>
<% end %>

<% unless @facturacion.resultado == "Rechazado" %>

  <% if Current.user.solicitar && @facturacion.paso_actual == 3  %>
    <div class="bg-gray-900 p-4 rounded-lg shadow-md mt-8">
      <h3 class="text-xl font-semibold text-white mb-4">Subir Orden de Compra</h3>

      <%= form_with(model: @facturacion, url: upload_orden_compra_facturacion_path(@facturacion), local: true, class: "space-y-4") do |form| %>
        <div>
          <%= form.label :orden_compra_file, "Archivo de Orden de Compra (PDF, PNG, JPG o JPEG)", class: "block text-gray-300 font-bold mb-2" %>
          <%= form.file_field :orden_compra_file, accept: "application/pdf,image/png,image/jpeg,image/jpg", class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" %>
        </div>

        <div>
          <%= form.label :resultado, "Resultado", class: "block text-gray-300 font-bold mb-2" %>
          <div class="flex space-x-4">
            <label class="flex items-center space-x-2 text-gray-300">
              <%= form.radio_button :resultado, 2, class: "form-radio text-green-500" %>
              <span>Aceptado</span>
            </label>
            <label class="flex items-center space-x-2 text-gray-300">
              <%= form.radio_button :resultado, 3, class: "form-radio text-red-500" %>
              <span>Rechazado</span>
            </label>
          </div>
        </div>

        <div class="mt-4">
          <%= form.submit "Subir Resultado", class: "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline cursor-pointer" %>
        </div>
      <% end %>

    </div>
  <% end %>

<% end %>


<% if Current.user.cotizar && @facturacion.paso_actual == 4  %>
  <div class="bg-gray-900 p-4 rounded-lg shadow-md mt-8">
    <h3 class="text-xl font-semibold text-white mb-4">Registrar Fecha de Evaluación</h3>

    <%= form_with(model: @facturacion,
                  url: update_fecha_inspeccion_facturacion_path(@facturacion),
                  method: :patch,
                  local: true,
                  class: "space-y-4") do |form| %>

      <div>
        <%= form.label :fecha_inspeccion, "Fecha de Evaluación", class: "block text-gray-300 font-bold mb-2" %>
        <div class="relative">
          <%= form.text_field :fecha_inspeccion,
                              placeholder: "Selecciona una fecha",
                              id: "datepicker",
                              class: "block w-full px-3 py-2 bg-gray-700 text-white border \
                                      border-gray-600 rounded-md shadow-sm focus:outline-none \
                                      focus:ring focus:ring-blue-500" %>
        </div>
      </div>

      <div class="mt-4">
        <%= form.submit "Registrar Evaluación",
                        class: "w-full bg-green-600 hover:bg-green-700 text-white font-bold \
                                py-2 px-4 rounded focus:outline-none focus:shadow-outline cursor-pointer" %>
      </div>
    <% end %>
  </div>

  <script>
      function initializeFlatpickr() {
          flatpickr("#datepicker", {
              dateFormat: "d-m-Y", // Formato dd-mm-yyyy
              minDate: "01-01-2020", // Fecha mínima, ajusta a conveniencia
              maxDate: "31-12-3000", // Fecha máxima, ajusta a conveniencia
              locale: "es",         // Idioma español
              static: false,        // Compatible con móviles
              altInput: true,
              altFormat: "d-m-Y",
          });
      }

      document.addEventListener("DOMContentLoaded", initializeFlatpickr);
      document.addEventListener("turbo:render", initializeFlatpickr);
      document.addEventListener("turbo:load", initializeFlatpickr);
  </script>
<% end %>



<% if Current.user.cotizar && @facturacion.paso_actual == 5  %>
  <div class="bg-gray-900 p-4 rounded-lg shadow-md mt-8">
    <h3 class="text-xl font-semibold text-white mb-4">Subir Factura</h3>

    <%= form_with(model: @facturacion, url: upload_factura_facturacion_path(@facturacion), local: true, class: "space-y-4") do |form| %>
      <div>
        <%= form.label :facturacion_file, "Archivo de Factura (PDF)", class: "block text-gray-300 font-bold mb-2" %>
        <%= form.file_field :facturacion_file, accept: "application/pdf", class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" %>
      </div>



      <div class="mt-4">
        <%= form.submit "Subir Factura", class: "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline cursor-pointer" %>
      </div>
    <% end %>
  </div>


<% end %>



<div class="bg-gray-900 p-4 rounded-lg shadow-md mt-8">
  <h3 class="text-xl font-semibold text-white mb-4">Observaciones</h3>

  <div class="bg-gray-800 p-4 rounded-lg mb-4 shadow">
    <form id="new-observacion-form" action="<%= facturacion_observacions_path(@facturacion) %>" method="post">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      <textarea
        name="observacion[texto]"
        id="new-observacion-text"
        rows="2"
        placeholder="Añade un comentario..."
        class="block w-full px-3 py-2 bg-gray-700 text-white border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring focus:ring-blue-500 mb-2"></textarea>
      <button
        type="submit"
        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline cursor-pointer">
        Enviar
      </button>
    </form>
  </div>

  <div id="observaciones-list">
    <% @facturacion.observacions.order(created_at: :desc).each do |observacion| %>
      <div id="observacion-<%= observacion.id %>" class="bg-gray-800 p-4 rounded-lg mb-4 shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-400">
              <strong><%= observacion.user&.real_name || "Anónimo" %></strong>
              - <span class="italic text-gray-300">Se hizo en: <%= observacion.momento %></span>
            </p>
          </div>
          <% if observacion.user == Current.user %>
            <div class="flex space-x-2">
              <button
                class="text-blue-400 hover:underline mr-4"
                onclick="editObservacion(<%= observacion.id %>, '<%= j observacion.texto %>')">
                Editar
              </button>
              <button
                class="text-red-400 hover:underline"
                onclick="deleteObservacion(<%= observacion.id %>)">
                Eliminar
              </button>
            </div>
          <% end %>
        </div>
        <p id="observacion-text-<%= observacion.id %>" class="mt-2 text-white"><%= observacion.texto %></p>
      </div>
    <% end %>
  </div>

</div>

<script>
    document.getElementById("new-observacion-form").addEventListener("submit", function (event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        fetch(form.action, {
            method: "POST",
            body: formData,
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    const newCommentHtml = `
            <div id="observacion-${data.observacion.id}" class="bg-gray-800 p-4 rounded-lg mb-4 shadow">
              <div class="flex items-center justify-between">
                <p class="text-sm text-gray-400">
                  <strong>${data.user_name}</strong> - <span>${data.momento}</span>
                </p>
              <div class="flex space-x-4">
                <button
                  class="text-blue-400 hover:underline"
                  onclick="editObservacion(${data.observacion.id}, '${data.observacion.texto}')">
                  Editar
                </button>
                <button
                  class="text-red-400 hover:underline"
                  onclick="deleteObservacion(${data.observacion.id})">
                  Eliminar
                </button>
              </div>

              </div>
              <p id="observacion-text-${data.observacion.id}" class="mt-2 text-white">${data.observacion.texto}</p>
            </div>
          `;
                    document.getElementById("observaciones-list").insertAdjacentHTML("afterbegin", newCommentHtml);
                    document.getElementById("new-observacion-text").value = "";
                } else {
                    alert("No se pudo guardar la observación.");
                }
            });
    });

    function editObservacion(id, texto) {
        const observacionTextEl = document.getElementById(`observacion-text-${id}`);
        observacionTextEl.outerHTML = `
    <form id="edit-observacion-form-${id}" action="/cotizaciones/<%= @facturacion.id %>/observacions/${id}" method="post">
      <input type="hidden" name="_method" value="patch">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      <textarea
        name="observacion[texto]"
        rows="2"
        class="block w-full px-3 py-2 bg-gray-700 text-white border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring focus:ring-blue-500 mb-2">${texto}</textarea>
      <button
        type="submit"
        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline cursor-pointer">
        Guardar
      </button>
    </form>
  `;

        document.getElementById(`edit-observacion-form-${id}`).addEventListener("submit", function (event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            fetch(form.action, {
                method: "POST",
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        const updatedText = `
            <p id="observacion-text-${id}" class="mt-2 text-white">${data.observacion.texto}</p>
          `;
                        form.outerHTML = updatedText;
                    } else {
                        alert("No se pudo actualizar la observación.");
                    }
                });
        });
    }


    function deleteObservacion(id) {
        Swal.fire({
            title: "¿Estás seguro?",
            text: "Esta acción eliminará la observación de forma permanente.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Sí, eliminar",
            cancelButtonText: "Cancelar",
            customClass: {
                confirmButton: 'mr-10'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/cotizaciones/<%= @facturacion.id %>/observacions/${id}`, {
                    method: "DELETE",
                    headers: {
                        "X-CSRF-Token": "<%= form_authenticity_token %>",
                    },
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            document.getElementById(`observacion-${id}`).remove();
                            Swal.fire(
                                "Eliminado",
                                "La observación ha sido eliminada correctamente.",
                                "success"
                            );
                        } else {
                            Swal.fire(
                                "Error",
                                "No se pudo eliminar la observación. Intenta nuevamente.",
                                "error"
                            );
                        }
                    });
            }
        });
    }

</script>


<script>
    function startEditPrecio() {
        const container = document.getElementById('precio-container');
        const currentPrecio = document.getElementById('precio-text').innerText.trim();

        container.innerHTML = `
      <form id="edit-precio-form" onsubmit="submitEditPrecio(event)">
        <!-- Necesitamos el token de protección CSRF: -->
        <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
        <label><strong>Precio (sin iva):</strong></label>
        <input
          type="number"
          name="facturacion[precio]"
          step="any"
          id="edit-precio-input"
          class="bg-gray-700 text-white border border-gray-600 rounded-md p-1 ml-2"
          value="${currentPrecio}"
        />
        <button
          type="submit"
          class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded ml-2">
          Guardar
        </button>
      </form>
    `;
    }

    function submitEditPrecio(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        fetch('<%= update_price_facturacion_path(@facturacion) %>', {
            method: 'PATCH',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const container = document.getElementById('precio-container');
                    container.innerHTML = `
          <strong>Precio (sin iva):</strong>
          <span id="precio-text">${data.precio}</span> UF
          <button
            id="editar-precio-btn"
            class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-600 text-white ml-2"
            onclick="startEditPrecio()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 stroke-width="2" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M15.232 5.232l3.536 3.536M2.999 17.999l4.242-.354.354-4.242
                       9.536-9.536a1.5 1.5 0 012.121 0l.707.707a1.5 1.5 0
                       010 2.121l-9.536 9.536z" />
            </svg>
          </button>
        `;
                } else {
                    alert("No se pudo actualizar el precio. Revisa el valor ingresado.");
                }
            })
            .catch(error => {
                console.error(error);
                alert("Ha ocurrido un error al actualizar el precio.");
            });
    }
</script>